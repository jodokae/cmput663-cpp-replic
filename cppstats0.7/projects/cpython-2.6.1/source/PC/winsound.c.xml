<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.sdml.info/srcML/src" xmlns:cpp="http://www.sdml.info/srcML/cpp" language="C" filename="projects/cpython-2.6.1/source/PC/winsound.c"><comment type="block">/* Author: Toby Dickenson &lt;htrd90@zepler.org&gt;
 *
 * Copyright (c) 1999 Toby Dickenson
 *
 * Permission to use this software in any way is granted without
 * fee, provided that the copyright notice above appears in all
 * copies. This software is provided "as is" without any warranty.
 */</comment>

<comment type="block">/* Modified by Guido van Rossum */</comment>
<comment type="block">/* Beep added by Mark Hammond */</comment>
<comment type="block">/* Win9X Beep and platform identification added by Uncle Timmy */</comment>

<comment type="block">/* Example:

   import winsound
   import time

   # Play wav file
   winsound.PlaySound('c:/windows/media/Chord.wav', winsound.SND_FILENAME)

   # Play sound from control panel settings
   winsound.PlaySound('SystemQuestion', winsound.SND_ALIAS)

   # Play wav file from memory
   data=open('c:/windows/media/Chimes.wav',"rb").read()
   winsound.PlaySound(data, winsound.SND_MEMORY)

   # Start playing the first bit of wav file asynchronously
   winsound.PlaySound('c:/windows/media/Chord.wav',
                   winsound.SND_FILENAME|winsound.SND_ASYNC)
   # But dont let it go for too long...
   time.sleep(0.1)
   # ...Before stopping it
   winsound.PlaySound(None, 0)
*/</comment>

<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;Python.h&gt;</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;windows.h&gt;</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;mmsystem.h&gt;</cpp:file></cpp:include>

<expr_stmt><expr><call><name>PyDoc_STRVAR</name><argument_list>(<argument><expr><name>sound_playsound_doc</name></expr></argument>,
<argument><expr>"PlaySound(sound, flags) - a wrapper around the Windows PlaySound API\n"
"\n"
"The sound argument can be a filename, data, or None.\n"
"For flag values, ored together, see module documentation."</expr></argument>)</argument_list></call></expr>;</expr_stmt>

<expr_stmt><expr><call><name>PyDoc_STRVAR</name><argument_list>(<argument><expr><name>sound_beep_doc</name></expr></argument>,
<argument><expr>"Beep(frequency, duration) - a wrapper around the Windows Beep API\n"
"\n"
"The frequency argument specifies frequency, in hertz, of the sound.\n"
"This parameter must be in the range 37 through 32,767.\n"
"The duration argument specifies the number of milliseconds.\n"</expr></argument>)</argument_list></call></expr>;</expr_stmt>

<expr_stmt><expr><call><name>PyDoc_STRVAR</name><argument_list>(<argument><expr><name>sound_msgbeep_doc</name></expr></argument>,
<argument><expr>"MessageBeep(x) - call Windows MessageBeep(x). x defaults to MB_OK."</expr></argument>)</argument_list></call></expr>;</expr_stmt>

<expr_stmt><expr><call><name>PyDoc_STRVAR</name><argument_list>(<argument><expr><name>sound_module_doc</name></expr></argument>,
<argument><expr>"PlaySound(sound, flags) - play a sound\n"
"SND_FILENAME - sound is a wav file name\n"
"SND_ALIAS - sound is a registry sound association name\n"
"SND_LOOP - Play the sound repeatedly; must also specify SND_ASYNC\n"
"SND_MEMORY - sound is a memory image of a wav file\n"
"SND_PURGE - stop all instances of the specified sound\n"
"SND_ASYNC - PlaySound returns immediately\n"
"SND_NODEFAULT - Do not play a default beep if the sound can not be found\n"
"SND_NOSTOP - Do not interrupt any sounds currently playing\n"  <comment type="line">// Raising RuntimeError if needed</comment>
"SND_NOWAIT - Return immediately if the sound driver is busy\n" <comment type="line">// Without any errors</comment>
"\n"
"Beep(frequency, duration) - Make a beep through the PC speaker."</expr></argument>)</argument_list></call></expr>;</expr_stmt>

<function><type><specifier>static</specifier> <name>PyObject</name> *</type>
<name>sound_playsound</name><parameter_list>(<param><decl><type><name>PyObject</name> *</type><name>s</name></decl></param>, <param><decl><type><name>PyObject</name> *</type><name>args</name></decl></param>)</parameter_list>
<block>{
    <decl_stmt><decl><type><specifier>const</specifier> <name>char</name> *</type><name>sound</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>flags</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>length</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>ok</name></decl>;</decl_stmt>

    <if>if<condition>(<expr>!<call><name>PyArg_ParseTuple</name><argument_list>(<argument><expr><name>args</name></expr></argument>,<argument><expr>"z#i:PlaySound"</expr></argument>,<argument><expr>&amp;<name>sound</name></expr></argument>,<argument><expr>&amp;<name>length</name></expr></argument>,<argument><expr>&amp;<name>flags</name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>

    <if>if<condition>(<expr><name>flags</name>&amp;<name>SND_ASYNC</name> &amp;&amp; <name>flags</name> &amp;<name>SND_MEMORY</name></expr>)</condition><then> <block>{
	<comment type="block">/* Sidestep reference counting headache; unfortunately this also
	   prevent SND_LOOP from memory. */</comment>
        <expr_stmt><expr><call><name>PyErr_SetString</name><argument_list>(<argument><expr><name>PyExc_RuntimeError</name></expr></argument>,<argument><expr>"Cannot play asynchronously from memory"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>

    <decl_stmt><decl><type><name>Py_BEGIN_ALLOW_THREADS</name></type>
    <name>ok</name> <init>= <expr><call><name>PlaySound</name><argument_list>(<argument><expr><name>sound</name></expr></argument>,<argument><expr><name>NULL</name></expr></argument>,<argument><expr><name>flags</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
    <macro><name>Py_END_ALLOW_THREADS</name></macro>
    <if>if<condition>(<expr>!<name>ok</name></expr>)</condition><then>
    <block>{
        <expr_stmt><expr><call><name>PyErr_SetString</name><argument_list>(<argument><expr><name>PyExc_RuntimeError</name></expr></argument>,<argument><expr>"Failed to play sound"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><call><name>Py_INCREF</name><argument_list>(<argument><expr><name>Py_None</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><name>Py_None</name></expr>;</return>
}</block></function>

<function><type><specifier>static</specifier> <name>PyObject</name> *</type>
<name>sound_beep</name><parameter_list>(<param><decl><type><name>PyObject</name> *</type><name>self</name></decl></param>, <param><decl><type><name>PyObject</name> *</type><name>args</name></decl></param>)</parameter_list>
<block>{
	<decl_stmt><decl><type><name>int</name></type> <name>freq</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>int</name></type> <name>dur</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>BOOL</name></type> <name>ok</name></decl>;</decl_stmt>

	<if>if <condition>(<expr>!<call><name>PyArg_ParseTuple</name><argument_list>(<argument><expr><name>args</name></expr></argument>, <argument><expr>"ii:Beep"</expr></argument>, <argument><expr>&amp;<name>freq</name></expr></argument>,  <argument><expr>&amp;<name>dur</name></expr></argument>)</argument_list></call></expr>)</condition><then>
		<return>return <expr><name>NULL</name></expr>;</return></then></if>

	<if>if <condition>(<expr><name>freq</name> &lt; 37 || <name>freq</name> &gt; 32767</expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>PyErr_SetString</name><argument_list>(<argument><expr><name>PyExc_ValueError</name></expr></argument>,
				<argument><expr>"frequency must be in 37 thru 32767"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return>return <expr><name>NULL</name></expr>;</return>
	}</block></then></if>

	<decl_stmt><decl><type><name>Py_BEGIN_ALLOW_THREADS</name></type>
	<name>ok</name> <init>= <expr><call><name>Beep</name><argument_list>(<argument><expr><name>freq</name></expr></argument>, <argument><expr><name>dur</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
	<macro><name>Py_END_ALLOW_THREADS</name></macro>
	<if>if <condition>(<expr>!<name>ok</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>PyErr_SetString</name><argument_list>(<argument><expr><name>PyExc_RuntimeError</name></expr></argument>,<argument><expr>"Failed to beep"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return>return <expr><name>NULL</name></expr>;</return>
	}</block></then></if>

	<expr_stmt><expr><call><name>Py_INCREF</name><argument_list>(<argument><expr><name>Py_None</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><name>Py_None</name></expr>;</return>
}</block></function>

<function><type><specifier>static</specifier> <name>PyObject</name> *</type>
<name>sound_msgbeep</name><parameter_list>(<param><decl><type><name>PyObject</name> *</type><name>self</name></decl></param>, <param><decl><type><name>PyObject</name> *</type><name>args</name></decl></param>)</parameter_list>
<block>{
	<decl_stmt><decl><type><name>int</name></type> <name>x</name> <init>= <expr><name>MB_OK</name></expr></init></decl>;</decl_stmt>
	<if>if <condition>(<expr>!<call><name>PyArg_ParseTuple</name><argument_list>(<argument><expr><name>args</name></expr></argument>, <argument><expr>"|i:MessageBeep"</expr></argument>, <argument><expr>&amp;<name>x</name></expr></argument>)</argument_list></call></expr>)</condition><then>
		<return>return <expr><name>NULL</name></expr>;</return></then></if>
	<expr_stmt><expr><call><name>MessageBeep</name><argument_list>(<argument><expr><name>x</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>Py_INCREF</name><argument_list>(<argument><expr><name>Py_None</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><name>Py_None</name></expr>;</return>
}</block></function>

<decl_stmt><decl><type><specifier>static</specifier> struct <name>PyMethodDef</name></type> <name><name>sound_methods</name><index>[]</index></name> <init>=
<expr><block>{
    <expr><block>{<expr>"PlaySound"</expr>, <expr><name>sound_playsound</name></expr>, <expr><name>METH_VARARGS</name></expr>, <expr><name>sound_playsound_doc</name></expr>}</block></expr>,
    <expr><block>{<expr>"Beep"</expr>,      <expr><name>sound_beep</name></expr>,      <expr><name>METH_VARARGS</name></expr>, <expr><name>sound_beep_doc</name></expr>}</block></expr>,
    <expr><block>{<expr>"MessageBeep"</expr>, <expr><name>sound_msgbeep</name></expr>, <expr><name>METH_VARARGS</name></expr>, <expr><name>sound_msgbeep_doc</name></expr>}</block></expr>,
    <expr><block>{<expr><name>NULL</name></expr>,  <expr><name>NULL</name></expr>}</block></expr>
}</block></expr></init></decl>;</decl_stmt>

<function><type><specifier>static</specifier> <name>void</name></type>
<name>add_define</name><parameter_list>(<param><decl><type><name>PyObject</name> *</type><name>dict</name></decl></param>, <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>key</name></decl></param>, <param><decl><type><name>long</name></type> <name>value</name></decl></param>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>PyObject</name> *</type><name>k</name><init>=<expr><call><name>PyString_FromString</name><argument_list>(<argument><expr><name>key</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>PyObject</name> *</type><name>v</name><init>=<expr><call><name>PyLong_FromLong</name><argument_list>(<argument><expr><name>value</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
    <if>if<condition>(<expr><name>v</name>&amp;&amp;<name>k</name></expr>)</condition><then>
    <block>{
        <expr_stmt><expr><call><name>PyDict_SetItem</name><argument_list>(<argument><expr><name>dict</name></expr></argument>,<argument><expr><name>k</name></expr></argument>,<argument><expr><name>v</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>
    <expr_stmt><expr><call><name>Py_XDECREF</name><argument_list>(<argument><expr><name>k</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>Py_XDECREF</name><argument_list>(<argument><expr><name>v</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
}</block></function>

<cpp:define>#<cpp:directive>define</cpp:directive> <cpp:macro><name>ADD_DEFINE</name><parameter_list>(<param><type><name>tok</name></type></param>)</parameter_list></cpp:macro> <cpp:value>add_define(dict,#tok,tok)</cpp:value></cpp:define>

<function><type><name>PyMODINIT_FUNC</name></type>
<name>initwinsound</name><parameter_list>(<param><decl><type><name>void</name></type></decl></param>)</parameter_list>
<block>{
	<decl_stmt><decl><type><name>PyObject</name> *</type><name>dict</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>PyObject</name> *</type><name>module</name> <init>= <expr><call><name>Py_InitModule3</name><argument_list>(<argument><expr>"winsound"</expr></argument>,
					  <argument><expr><name>sound_methods</name></expr></argument>,
					  <argument><expr><name>sound_module_doc</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
	<if>if <condition>(<expr><name>module</name> == <name>NULL</name></expr>)</condition><then>
		<return>return;</return></then></if>
	<expr_stmt><expr><name>dict</name> = <call><name>PyModule_GetDict</name><argument_list>(<argument><expr><name>module</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_ASYNC</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_NODEFAULT</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_NOSTOP</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_NOWAIT</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_ALIAS</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_FILENAME</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_MEMORY</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_PURGE</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_LOOP</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>SND_APPLICATION</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>MB_OK</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>MB_ICONASTERISK</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>MB_ICONEXCLAMATION</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>MB_ICONHAND</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ADD_DEFINE</name><argument_list>(<argument><expr><name>MB_ICONQUESTION</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
}</block></function>
</unit>
