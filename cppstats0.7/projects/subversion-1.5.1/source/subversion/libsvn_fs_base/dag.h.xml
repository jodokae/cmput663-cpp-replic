<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.sdml.info/srcML/src" xmlns:cpp="http://www.sdml.info/srcML/cpp" language="C" filename="projects/subversion-1.5.1/source/subversion/libsvn_fs_base/dag.h"><comment type="block">/* dag.h : DAG-like interface filesystem, private to libsvn_fs
 *
 * ====================================================================
 * Copyright (c) 2000-2006 CollabNet.  All rights reserved.
 *
 * This software is licensed as described in the file COPYING, which
 * you should have received as part of this distribution.  The terms
 * are also available at http://subversion.tigris.org/license-1.html.
 * If newer versions of this license are posted there, you may use a
 * newer version instead, at your option.
 *
 * This software consists of voluntary contributions made by many
 * individuals.  For exact contribution history, see the revision
 * history and logs, available at http://subversion.tigris.org/.
 * ====================================================================
 */</comment>

<cpp:ifndef>#<cpp:directive>ifndef</cpp:directive> <name>SVN_LIBSVN_FS_DAG_H</name></cpp:ifndef>
<cpp:define>#<cpp:directive>define</cpp:directive> <cpp:macro><name>SVN_LIBSVN_FS_DAG_H</name></cpp:macro></cpp:define>

<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"svn_fs.h"</cpp:file></cpp:include>

<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"trail.h"</cpp:file></cpp:include>

<cpp:ifdef>#<cpp:directive>ifdef</cpp:directive> <name>__cplusplus</name></cpp:ifdef>
<extern>extern "C" <block>{
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif> <comment type="block">/* __cplusplus */</comment>

<escape char="0xc"/>
<comment type="block">/* The interface in this file provides all the essential filesystem
   operations, but exposes the filesystem's DAG structure.  This makes
   it simpler to implement than the public interface, since a client
   of this interface has to understand and cope with shared structure
   directly as it appears in the database.  However, it's still a
   self-consistent set of invariants to maintain, making it
   (hopefully) a useful interface boundary.

   In other words:

   - The dag_node_t interface exposes the internal DAG structure of
     the filesystem, while the svn_fs.h interface does any cloning
     necessary to make the filesystem look like a tree.

   - The dag_node_t interface exposes the existence of copy nodes,
     whereas the svn_fs.h handles them transparently.

   - dag_node_t's must be explicitly cloned, whereas the svn_fs.h
     operations make clones implicitly.

   - Callers of the dag_node_t interface use Berkeley DB transactions
     to ensure consistency between operations, while callers of the
     svn_fs.h interface use Subversion transactions.  */</comment>

<escape char="0xc"/>
<comment type="block">/* Initializing a filesystem.  */</comment>


<comment type="block">/* Given a filesystem FS, which contains all the necessary tables,
   create the initial revision 0, and the initial root directory.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_init_fs</name><parameter_list>(<param><decl><type><name>svn_fs_t</name> *</type><name>fs</name></decl></param>)</parameter_list>;</function_decl>


<escape char="0xc"/>
<comment type="block">/* Generic DAG node stuff.  */</comment>

<typedef>typedef <type>struct <name>dag_node_t</name></type> <name>dag_node_t</name>;</typedef>


<comment type="block">/* Fill *NODE with a dag_node_t representing node revision ID in FS,
   allocating in POOL.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_get_node</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>node</name></decl></param>,
                                       <param><decl><type><name>svn_fs_t</name> *</type><name>fs</name></decl></param>,
                                       <param><decl><type><specifier>const</specifier> <name>svn_fs_id_t</name> *</type><name>id</name></decl></param>,
                                       <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                       <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Return a new dag_node_t object referring to the same node as NODE,
   allocated in POOL.  */</comment>
<function_decl><type><name>dag_node_t</name> *</type><name>svn_fs_base__dag_dup</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                 <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Return the filesystem containing NODE.  */</comment>
<function_decl><type><name>svn_fs_t</name> *</type><name>svn_fs_base__dag_get_fs</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Set *REV to NODE's revision number, as part of TRAIL.  If NODE has
   never been committed as part of a revision, set *REV to
   SVN_INVALID_REVNUM.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_get_revision</name><parameter_list>(<param><decl><type><name>svn_revnum_t</name> *</type><name>rev</name></decl></param>,
                                           <param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                           <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                           <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Return the node revision ID of NODE.  The value returned is shared
   with NODE, and will be deallocated when NODE is.  */</comment>
<function_decl><type><specifier>const</specifier> <name>svn_fs_id_t</name> *</type><name>svn_fs_base__dag_get_id</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Return the created path of NODE.  The value returned is shared
   with NODE, and will be deallocated when NODE is.  */</comment>
<function_decl><type><specifier>const</specifier> <name>char</name> *</type><name>svn_fs_base__dag_get_created_path</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Set *ID_P to the node revision ID of NODE's immediate predecessor,
   or NULL if NODE has no predecessor, as part of TRAIL.  The returned
   ID will be allocated in POOL.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_get_predecessor_id</name><parameter_list>(<param><decl><type><specifier>const</specifier> <name>svn_fs_id_t</name> **</type><name>id_p</name></decl></param>,
                                                 <param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                                 <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                                 <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Set *COUNT to the number of predecessors NODE has (recursively), or
   -1 if not known, as part of TRAIL.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_get_predecessor_count</name><parameter_list>(<param><decl><type><name>int</name> *</type><name>count</name></decl></param>,
                                                    <param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                                    <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                                    <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Return non-zero IFF NODE is currently mutable under Subversion
   transaction TXN_ID.  */</comment>
<function_decl><type><name>svn_boolean_t</name></type> <name>svn_fs_base__dag_check_mutable</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                             <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>)</parameter_list>;</function_decl>

<comment type="block">/* Return the node kind of NODE. */</comment>
<function_decl><type><name>svn_node_kind_t</name></type> <name>svn_fs_base__dag_node_kind</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>)</parameter_list>;</function_decl>

<comment type="block">/* Set *PROPLIST_P to a PROPLIST hash representing the entire property
   list of NODE, as part of TRAIL.  The hash has const char * names
   (the property names) and svn_string_t * values (the property values).

   If properties do not exist on NODE, *PROPLIST_P will be set to NULL.

   The returned property list is allocated in POOL.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_get_proplist</name><parameter_list>(<param><decl><type><name>apr_hash_t</name> **</type><name>proplist_p</name></decl></param>,
                                           <param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                           <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                           <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>

<comment type="block">/* Set the property list of NODE to PROPLIST, as part of TRAIL.  The
   node being changed must be mutable.  TXN_ID is the Subversion
   transaction under which this occurs.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_set_proplist</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                           <param><decl><type><name>apr_hash_t</name> *</type><name>proplist</name></decl></param>,
                                           <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                           <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                           <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<escape char="0xc"/>
<comment type="block">/* Mergeinfo tracking stuff. */</comment>

<comment type="block">/* If HAS_MERGEINFO is not null, set *HAS_MERGEINFO to TRUE iff NODE
   records that its property list contains merge tracking information.

   If COUNT is not null, set *COUNT to the number of nodes --
   including NODE itself -- in the subtree rooted at NODE which claim
   to carry merge tracking information.

   Do this as part of TRAIL, and use POOL for necessary allocations.

   NOTE:  No validation against NODE's actual property list is
   performed. */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_get_mergeinfo_stats</name><parameter_list>(<param><decl><type><name>svn_boolean_t</name> *</type><name>has_mergeinfo</name></decl></param>,
                                                  <param><decl><type><name>apr_int64_t</name> *</type><name>count</name></decl></param>,
                                                  <param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                                  <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                                  <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>

<comment type="block">/* If HAS_MERGEINFO is set, record on NODE that its property list
   carries merge tracking information.  Otherwise, record on NODE its
   property list does *not* carry merge tracking information.  NODE
   must be mutable under TXN_ID (the Subversion transaction under
   which this operation occurs).  Set *HAD_MERGEINFO to the previous
   state of this record.

   Update the mergeinfo count on NODE as necessary.

   Do all of this as part of TRAIL, and use POOL for necessary
   allocations.

   NOTE:  No validation against NODE's actual property list is
   performed. */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_set_has_mergeinfo</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                                <param><decl><type><name>svn_boolean_t</name></type> <name>has_mergeinfo</name></decl></param>,
                                                <param><decl><type><name>svn_boolean_t</name> *</type><name>had_mergeinfo</name></decl></param>,
                                                <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                                <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                                <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>

<comment type="block">/* Record on NODE a change of COUNT_DELTA nodes -- including NODE
   itself -- in the subtree rooted at NODE claim to carry merge
   tracking information.  That is, add COUNT_DELTA to NODE's current
   mergeinfo count (regardless of whether COUNT_DELTA is a positive or
   negative integer).

   NODE must be mutable under TXN_ID (the Subversion transaction under
   which this operation occurs).  Do this as part of TRAIL, and use
   POOL for necessary allocations.

   NOTE:  No validation of these claims is performed. */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_adjust_mergeinfo_count</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                                     <param><decl><type><name>apr_int64_t</name></type> <name>count_delta</name></decl></param>,
                                                     <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                                     <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                                     <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>

<escape char="0xc"/>
<comment type="block">/* Revision and transaction roots.  */</comment>


<comment type="block">/* Open the root of revision REV of filesystem FS, as part of TRAIL.
   Set *NODE_P to the new node.  Allocate the node in POOL.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_revision_root</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>node_p</name></decl></param>,
                                            <param><decl><type><name>svn_fs_t</name> *</type><name>fs</name></decl></param>,
                                            <param><decl><type><name>svn_revnum_t</name></type> <name>rev</name></decl></param>,
                                            <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                            <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Set *NODE_P to the root of transaction TXN_ID in FS, as part
   of TRAIL.  Allocate the node in POOL.

   Note that the root node of TXN_ID is not necessarily mutable.  If no
   changes have been made in the transaction, then it may share its
   root directory with its base revision.  To get a mutable root node
   for a transaction, call svn_fs_base__dag_clone_root.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_txn_root</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>node_p</name></decl></param>,
                                       <param><decl><type><name>svn_fs_t</name> *</type><name>fs</name></decl></param>,
                                       <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                       <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                       <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Set *NODE_P to the base root of transaction TXN_ID in FS, as part
   of TRAIL.  Allocate the node in POOL.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_txn_base_root</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>node_p</name></decl></param>,
                                            <param><decl><type><name>svn_fs_t</name> *</type><name>fs</name></decl></param>,
                                            <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                            <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                            <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Clone the root directory of TXN_ID in FS, and update the
   `transactions' table entry to point to it, unless this has been
   done already.  In either case, set *ROOT_P to a reference to the
   root directory clone.  Do all this as part of TRAIL, and allocate
   *ROOT_P in POOL.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_clone_root</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>root_p</name></decl></param>,
                                         <param><decl><type><name>svn_fs_t</name> *</type><name>fs</name></decl></param>,
                                         <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                         <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                         <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Commit the transaction TXN-&gt;id in TXN-&gt;FS, as part of TRAIL.  Store the
   new revision number in *NEW_REV.  This entails:
   - marking the tree of mutable nodes at TXN-&gt;id's root as immutable,
     and marking all their contents as stable
   - creating a new revision, with TXN-&gt;id's root as its root directory
   - promoting TXN-&gt;id to a "committed" transaction.

   Beware!  This does not make sure that TXN-&gt;id is based on the very
   latest revision in TXN-&gt;FS.  If the caller doesn't take care of this,
   you may lose people's work!

   Do any necessary temporary allocation in a subpool of POOL.
   Consume temporary space at most proportional to the maximum depth
   of SVN_TXN's tree of mutable nodes.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_commit_txn</name><parameter_list>(<param><decl><type><name>svn_revnum_t</name> *</type><name>new_rev</name></decl></param>,
                                         <param><decl><type><name>svn_fs_txn_t</name> *</type><name>txn</name></decl></param>,
                                         <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                         <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<escape char="0xc"/>
<comment type="block">/* Directories.  */</comment>


<comment type="block">/* Open the node named NAME in the directory PARENT, as part of TRAIL.
   Set *CHILD_P to the new node, allocated in POOL.  NAME must be a
   single path component; it cannot be a slash-separated directory
   path.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_open</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>child_p</name></decl></param>,
                                   <param><decl><type><name>dag_node_t</name> *</type><name>parent</name></decl></param>,
                                   <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>name</name></decl></param>,
                                   <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                   <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Set *ENTRIES_P to a hash table of NODE's entries, as part of TRAIL,
   or NULL if NODE has no entries.  The keys of the table are entry
   names, and the values are svn_fs_dirent_t's.

   The returned table is allocated in POOL.

   NOTE: the 'kind' field of the svn_fs_dirent_t's is set to
   svn_node_unknown by this function -- callers that need in
   interesting value in these slots should fill them in using a new
   TRAIL, since the list of entries can be arbitrarily large.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_dir_entries</name><parameter_list>(<param><decl><type><name>apr_hash_t</name> **</type><name>entries_p</name></decl></param>,
                                          <param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                          <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                          <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Set ENTRY_NAME in NODE to point to ID, as part of TRAIL.  NODE must
   be a mutable directory.  ID can refer to a mutable or immutable
   node.  If ENTRY_NAME does not exist, it will be created.  TXN_ID is
   the Subversion transaction under which this occurs.*/</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_set_entry</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>node</name></decl></param>,
                                        <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>entry_name</name></decl></param>,
                                        <param><decl><type><specifier>const</specifier> <name>svn_fs_id_t</name> *</type><name>id</name></decl></param>,
                                        <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                        <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                        <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Make a new mutable clone of the node named NAME in PARENT, and
   adjust PARENT's directory entry to point to it, as part of TRAIL,
   unless NAME in PARENT already refers to a mutable node.  In either
   case, set *CHILD_P to a reference to the new node, allocated in
   POOL.  PARENT must be mutable.  NAME must be a single path
   component; it cannot be a slash-separated directory path.
   PARENT_PATH must be the canonicalized absolute path of the parent
   directory.

   COPY_ID, if non-NULL, is a key into the `copies' table, and
   indicates that this new node is being created as the result of a
   copy operation, and specifically which operation that was.

   PATH is the canonicalized absolute path at which this node is being
   created.

   TXN_ID is the Subversion transaction under which this occurs.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_clone_child</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>child_p</name></decl></param>,
                                          <param><decl><type><name>dag_node_t</name> *</type><name>parent</name></decl></param>,
                                          <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>parent_path</name></decl></param>,
                                          <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>name</name></decl></param>,
                                          <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>copy_id</name></decl></param>,
                                          <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                          <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                          <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Delete the directory entry named NAME from PARENT, as part of
   TRAIL.  PARENT must be mutable.  NAME must be a single path
   component; it cannot be a slash-separated directory path.  If the
   node being deleted is a mutable directory, remove all mutable nodes
   reachable from it.  TXN_ID is the Subversion transaction under
   which this occurs.

   If return SVN_ERR_FS_NO_SUCH_ENTRY, then there is no entry NAME in
   PARENT.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_delete</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>parent</name></decl></param>,
                                     <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>name</name></decl></param>,
                                     <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                     <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                     <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Delete the node revision assigned to node ID from FS's `nodes'
   table, as part of TRAIL.  Also delete any mutable representations
   and strings associated with that node revision.  ID may refer to a
   file or directory, which must be mutable.  TXN_ID is the Subversion
   transaction under which this occurs.

   NOTE: If ID represents a directory, and that directory has mutable
   children, you risk orphaning those children by leaving them
   dangling, disconnected from all DAG trees.  It is assumed that
   callers of this interface know what in the world they are doing.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_remove_node</name><parameter_list>(<param><decl><type><name>svn_fs_t</name> *</type><name>fs</name></decl></param>,
                                          <param><decl><type><specifier>const</specifier> <name>svn_fs_id_t</name> *</type><name>id</name></decl></param>,
                                          <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                          <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                          <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Delete all mutable node revisions reachable from node ID, including
   ID itself, from FS's `nodes' table, as part of TRAIL.  Also delete
   any mutable representations and strings associated with that node
   revision.  ID may refer to a file or directory, which may be
   mutable or immutable.  TXN_ID is the Subversion transaction under
   which this occurs.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_delete_if_mutable</name><parameter_list>(<param><decl><type><name>svn_fs_t</name> *</type><name>fs</name></decl></param>,
                                                <param><decl><type><specifier>const</specifier> <name>svn_fs_id_t</name> *</type><name>id</name></decl></param>,
                                                <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                                <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                                <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Create a new mutable directory named NAME in PARENT, as part of
   TRAIL.  Set *CHILD_P to a reference to the new node, allocated in
   POOL.  The new directory has no contents, and no properties.
   PARENT must be mutable.  NAME must be a single path component; it
   cannot be a slash-separated directory path.  PARENT_PATH must be
   the canonicalized absolute path of the parent directory.  PARENT
   must not currently have an entry named NAME.  Do any temporary
   allocation in POOL.  TXN_ID is the Subversion transaction
   under which this occurs.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_make_dir</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>child_p</name></decl></param>,
                                       <param><decl><type><name>dag_node_t</name> *</type><name>parent</name></decl></param>,
                                       <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>parent_path</name></decl></param>,
                                       <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>name</name></decl></param>,
                                       <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                       <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                       <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<escape char="0xc"/>
<comment type="block">/* Files.  */</comment>


<comment type="block">/* Set *CONTENTS to a readable generic stream which yields the
   contents of FILE, as part of TRAIL.  Allocate the stream in POOL.
   If FILE is not a file, return SVN_ERR_FS_NOT_FILE.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_get_contents</name><parameter_list>(<param><decl><type><name>svn_stream_t</name> **</type><name>contents</name></decl></param>,
                                           <param><decl><type><name>dag_node_t</name> *</type><name>file</name></decl></param>,
                                           <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                           <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Return a generic writable stream in *CONTENTS with which to set the
   contents of FILE as part of TRAIL.  Allocate the stream in POOL.
   TXN_ID is the Subversion transaction under which this occurs.  Any
   previous edits on the file will be deleted, and a new edit stream
   will be constructed.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_get_edit_stream</name><parameter_list>(<param><decl><type><name>svn_stream_t</name> **</type><name>contents</name></decl></param>,
                                              <param><decl><type><name>dag_node_t</name> *</type><name>file</name></decl></param>,
                                              <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                              <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                              <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Signify the completion of edits to FILE made using the stream
   returned by svn_fs_base__dag_get_edit_stream, as part of TRAIL.  TXN_ID
   is the Subversion transaction under which this occurs.

   If CHECKSUM is non-null, it must match the checksum for FILE's
   contents (note: this is not recalculated, the recorded checksum is
   used), else the error SVN_ERR_CHECKSUM_MISMATCH is returned.

   This operation is a no-op if no edits are present.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_finalize_edits</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>file</name></decl></param>,
                                             <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>checksum</name></decl></param>,
                                             <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                             <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                             <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<comment type="block">/* Set *LENGTH to the length of the contents of FILE, as part of TRAIL. */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_file_length</name><parameter_list>(<param><decl><type><name>svn_filesize_t</name> *</type><name>length</name></decl></param>,
                                          <param><decl><type><name>dag_node_t</name> *</type><name>file</name></decl></param>,
                                          <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                          <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>

<comment type="block">/* Put the recorded MD5 checksum of FILE into DIGEST, as part of
 * TRAIL.  DIGEST must point to APR_MD5_DIGESTSIZE bytes of storage.
 *
 * If no stored checksum is available, do not calculate the checksum,
 * just put all 0's into DIGEST.
 */</comment>
<function_decl><type><name>svn_error_t</name> *</type>
<name>svn_fs_base__dag_file_checksum</name><parameter_list>(<param><decl><type><name>unsigned</name> <name>char</name></type> <name><name>digest</name><index>[]</index></name></decl></param>,
                               <param><decl><type><name>dag_node_t</name> *</type><name>file</name></decl></param>,
                               <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                               <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>

<comment type="block">/* Create a new mutable file named NAME in PARENT, as part of TRAIL.
   Set *CHILD_P to a reference to the new node, allocated in
   POOL.  The new file's contents are the empty string, and it
   has no properties.  PARENT must be mutable.  NAME must be a single
   path component; it cannot be a slash-separated directory path.
   PARENT_PATH must be the canonicalized absolute path of the parent
   directory.  TXN_ID is the Subversion transaction under which this
   occurs.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_make_file</name><parameter_list>(<param><decl><type><name>dag_node_t</name> **</type><name>child_p</name></decl></param>,
                                        <param><decl><type><name>dag_node_t</name> *</type><name>parent</name></decl></param>,
                                        <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>parent_path</name></decl></param>,
                                        <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>name</name></decl></param>,
                                        <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                        <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                        <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<escape char="0xc"/>
<comment type="block">/* Copies */</comment>

<comment type="block">/* Make ENTRY in TO_NODE be a copy of FROM_NODE, as part of TRAIL.
   TO_NODE must be mutable.  TXN_ID is the Subversion transaction
   under which this occurs.

   If PRESERVE_HISTORY is true, the new node will record that it was
   copied from FROM_PATH in FROM_REV; therefore, FROM_NODE should be
   the node found at FROM_PATH in FROM_REV, although this is not
   checked.

   If PRESERVE_HISTORY is false, FROM_PATH and FROM_REV are ignored.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_copy</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>to_node</name></decl></param>,
                                   <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>entry</name></decl></param>,
                                   <param><decl><type><name>dag_node_t</name> *</type><name>from_node</name></decl></param>,
                                   <param><decl><type><name>svn_boolean_t</name></type> <name>preserve_history</name></decl></param>,
                                   <param><decl><type><name>svn_revnum_t</name></type> <name>from_rev</name></decl></param>,
                                   <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>from_path</name></decl></param>,
                                   <param><decl><type><specifier>const</specifier> <name>char</name> *</type><name>txn_id</name></decl></param>,
                                   <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                   <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<escape char="0xc"/>
<comment type="block">/* Deltification */</comment>

<comment type="block">/* Change TARGET's representation to be a delta against SOURCE, as
   part of TRAIL.  If TARGET or SOURCE does not exist, do nothing and
   return success.  If PROPS_ONLY is non-zero, only the node property
   portion of TARGET will be deltified.

   WARNING WARNING WARNING: Do *NOT* call this with a mutable SOURCE
   node.  Things will go *very* sour if you deltify TARGET against a
   node that might just disappear from the filesystem in the (near)
   future.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__dag_deltify</name><parameter_list>(<param><decl><type><name>dag_node_t</name> *</type><name>target</name></decl></param>,
                                      <param><decl><type><name>dag_node_t</name> *</type><name>source</name></decl></param>,
                                      <param><decl><type><name>svn_boolean_t</name></type> <name>props_only</name></decl></param>,
                                      <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                      <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>

<escape char="0xc"/>
<comment type="block">/* Comparison */</comment>

<comment type="block">/* Find out what is the same between two nodes.

   If PROPS_CHANGED is non-null, set *PROPS_CHANGED to 1 if the two
   nodes have different property lists, or to 0 if same.

   If CONTENTS_CHANGED is non-null, set *CONTENTS_CHANGED to 1 if the
   two nodes have different contents, or to 0 if same.  For files,
   file contents are compared; for directories, the entries lists are
   compared.  If one is a file and the other is a directory, the one's
   contents will be compared to the other's entries list.  (Not
   terribly useful, I suppose, but that's the caller's business.)

   ### todo: This function only compares rep keys at the moment.  This
   may leave us with a slight chance of a false positive, though I
   don't really see how that would happen in practice.  Nevertheless,
   it should probably be fixed.  */</comment>
<function_decl><type><name>svn_error_t</name> *</type><name>svn_fs_base__things_different</name><parameter_list>(<param><decl><type><name>svn_boolean_t</name> *</type><name>props_changed</name></decl></param>,
                                           <param><decl><type><name>svn_boolean_t</name> *</type><name>contents_changed</name></decl></param>,
                                           <param><decl><type><name>dag_node_t</name> *</type><name>node1</name></decl></param>,
                                           <param><decl><type><name>dag_node_t</name> *</type><name>node2</name></decl></param>,
                                           <param><decl><type><name>trail_t</name> *</type><name>trail</name></decl></param>,
                                           <param><decl><type><name>apr_pool_t</name> *</type><name>pool</name></decl></param>)</parameter_list>;</function_decl>


<cpp:ifdef>#<cpp:directive>ifdef</cpp:directive> <name>__cplusplus</name></cpp:ifdef>
}</block></extern>
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif> <comment type="block">/* __cplusplus */</comment>

<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif> <comment type="block">/* SVN_LIBSVN_FS_DAG_H */</comment>
</unit>
